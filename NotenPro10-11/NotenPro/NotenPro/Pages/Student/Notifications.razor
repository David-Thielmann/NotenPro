@page "/student/notifications"
@using HTLKrems.GradeManagement.Models
@inject INotificationService NotificationService
@inject ISnackbar Snackbar

<PageTitle>Benachrichtigungen</PageTitle>

<MudText Typo="Typo.h4" Class="mb-6">Benachrichtigungen</MudText>

@if (isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else
{
    @foreach (var notification in notifications)
    {
        <MudCard Elevation="2" Class='@($"mb-3 {(notification.IsRead ? "" : "mud-theme-primary")}")'>
            <MudCardContent>
                <div class="d-flex align-center justify-space-between">
                    <div class="d-flex align-center flex-grow-1">
                        <MudIcon Icon='@GetNotificationIcon(notification.Type)'
                                 Color='@GetNotificationColor(notification.Type)'
                                 Class="mr-3" />
                        <div class="flex-grow-1">
                            <MudText Typo="Typo.subtitle1">@notification.Title</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@notification.Message</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                @notification.Timestamp.ToString("dd.MM.yyyy HH:mm")
                            </MudText>
                        </div>
                    </div>
                    @if (!notification.IsRead)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Check"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick='@(() => MarkAsRead(notification.Id))' />
                    }
                </div>
            </MudCardContent>
        </MudCard>
    }

    @if (!notifications.Any())
    {
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex flex-column align-center py-8">
                    <MudIcon Icon="@Icons.Material.Filled.Notifications" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">
                        Keine Benachrichtigungen
                    </MudText>
                </div>
            </MudCardContent>
        </MudCard>
    }
}

@code {
    private bool isLoading = true;
    private List<Notification> notifications = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        notifications = await NotificationService.GetMyNotificationsAsync();
        isLoading = false;
    }

    private async Task MarkAsRead(string id)
    {
        await NotificationService.MarkAsReadAsync(id);
        var notification = notifications.FirstOrDefault(n => n.Id == id);
        if (notification != null)
        {
            notification.IsRead = true;
            Snackbar.Add("Als gelesen markiert", Severity.Success);
        }
    }

    private string GetNotificationIcon(NotificationType type) => type switch
    {
        NotificationType.Success => Icons.Material.Filled.CheckCircle,
        NotificationType.Warning => Icons.Material.Filled.Warning,
        NotificationType.Error   => Icons.Material.Filled.Error,
        _                        => Icons.Material.Filled.Info
    };

    private Color GetNotificationColor(NotificationType type) => type switch
    {
        NotificationType.Success => Color.Success,
        NotificationType.Warning => Color.Warning,
        NotificationType.Error   => Color.Error,
        _                        => Color.Info
    };
}
